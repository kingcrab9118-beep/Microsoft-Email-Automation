version: '3.8'

services:
  email-automation:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile
    container_name: email-automation
    restart: unless-stopped
    environment:
      # Microsoft Graph API Configuration
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - SENDER_EMAIL=${SENDER_EMAIL}
      - AUTH_METHOD=${AUTH_METHOD:-client_credentials}
      
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/email_automation.db}
      
      # Rate Limiting
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-30}
      - RATE_LIMIT_PER_DAY=${RATE_LIMIT_PER_DAY:-10000}
      
      # Email Sequence Configuration
      - FOLLOW_UP_1_DELAY_DAYS=${FOLLOW_UP_1_DELAY_DAYS:-14}
      - FOLLOW_UP_2_ENABLED=${FOLLOW_UP_2_ENABLED:-true}
      - FOLLOW_UP_2_DELAY_DAYS=${FOLLOW_UP_2_DELAY_DAYS:-10}
      
      # Reply Detection
      - REPLY_CHECK_INTERVAL_MINUTES=${REPLY_CHECK_INTERVAL_MINUTES:-15}
    
    volumes:
      # Persistent data storage
      - email_data:/app/data
      - email_logs:/app/logs
      
      # Configuration override (optional)
      - ./config:/app/config:ro
    
    ports:
      # Monitoring port (optional, for health checks)
      - "8080:8080"
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Optional: Monitoring service
  monitoring:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile
    container_name: email-automation-monitoring
    restart: unless-stopped
    command: ["python", "monitoring.py", "--port", "8080"]
    environment:
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - SENDER_EMAIL=${SENDER_EMAIL}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/email_automation.db}
    
    volumes:
      - email_data:/app/data:ro
      - email_logs:/app/logs:ro
    
    ports:
      - "8081:8080"
    
    depends_on:
      - email-automation
    
    profiles:
      - monitoring

volumes:
  email_data:
    driver: local
  email_logs:
    driver: local

networks:
  default:
    name: email-automation-network